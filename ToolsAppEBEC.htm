<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Alquiler de herramientas</title>
	<!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
		
	<style>
		body{
			font-size:12px;
			font-family:Verdana;
			background:rgb(255,0,0);
		}
		TD{
			font-family:Verdana;
			font-size:10px;
		}
		A, A:LINK, A:VISITED {
			text-decoration:none;
		}
		#contenedor {
			position:relative;
			top:0px;
			left: 0px;
			height: 100%;
		}
		#main{
			position:absolute;
			top:0px;
			left:0px;
			margin-top:150px;
			padding-left:170px;
			text-align:center;
			height: 100%;
			background-position:bottom;
			background-repeat:no-repeat;
		}
	</style>
</head>

<body>

<div id="contenedor" style="width:3000px">
	<img id="imgback" src="fondoMainSpain.png">     
	<div id="main">		
		<p>&nbsp;<br>
		</p><div style="padding-left:0px" align="justify">
		<form name="a">
		<table border="3" align="center">
		<tbody>
		<tr>
      <th width="50" height="30" scope="col">Equipos</th>
      <th scope="col">Herramientas y Materiales </th>
      <th width="100" scope="col">Tiempo restante </th>
      <th width="230" scope="col">Controles</th>      
	  <th width="50" scope="col">Puntos</th>
	  <th width="50" scope="col">Num Veces</th>
	  <th width="500" scope="col">Comment</th>
	  <th width="1500" scope="col">History</th>
    </tr>
<script language="javascript" type="text/javascript">
<!--
	var Teams=[
	"1",
	"2",
	"3",
	"4",
	"5",
	"6"
	];
	var nSlots=4;
	var Herr=[
	//{herramienta,minutos_max,coste_coger,coste_minuto},

		["Prueba con un minuto (...)",1, 40, 0], //Borrar cuando se vaya a utilizar de verdad
		["Pistola de silicona(40)",30,40,0],
		["Sierra metal       (40)",30,25,0],
		["Serrucho madera    (25)",30,25,0],
		["Sierra de arco     (25)",30,25,0],
		["Guantes             (0)",30,0,0],
		["Martillo            (0)",30,0,0],
		["Tijeras             (0)",30,0,0],
		["Cutter              (0)",30,0,0],
		["Metro               (0)",30,0,0],
		["Alargador           (0)",30,0,0],
		["Destornillador      (0)",30,0,0],
		["Mat: Liston madera (10)",30,10,0],
		["Mat: Liston d4-6mm (10)",30,10,0],
		["Mat: Liston d8-10mm(15)",30,15,0],
		["Mat: Liston d12mm  (20)",30,20,0],
		["Mat: Liston 5x10	 (10)",30,10,0],
		["Mat: Varilla metal (30)",30,30,0],
		["Mat: Tuerca metal	 (10)",30,10,0],
		["Mat: Panel madera  (50)",30,50,0],
		["Mat: Panel corcho	 (50)",30,50,0],
		["Mat: Carton ondulad(20)",30,20,0],
		["Mat: Cuerda 1m	 (10)",30,10,0],
		["Mat: Hembrilla	  (5)",30,5,0],
		["Mat: Polea     	 (10)",30,30,0],
		["Mat: Clavos 2ud 	  (5)",30,5,0],
		["Mat: Gomas largas	  (2)",30,2,0],
		["Mat: Gomas cortas	  (1)",30,1,0],
		["Mat: Bridas    	  (5)",30,5,0],
		["Mat: Cola blanca	 (15)",30,15,0],
		["Mat: Cinta american(15)",30,15,0],

		["Pistola de silicona",30,40,0],
		["Sierra metal       ",30,25,0],
		["Serrucho madera    ",30,25,0],
		["Sierra de arco     ",30,25,0],
		["Guantes             ",30,0,0],
		["Martillo            ",30,0,0],
		["Tijeras             ",30,0,0],
		["Cutter              ",30,0,0],
		["Metro               ",30,0,0],
		["Alargador           ",30,0,0],
		["Destornillador      ",30,0,0],
		["Mat: Liston madera ",30,10,0],
		["Mat: Liston d4-6mm ",30,10,0],
		["Mat: Liston d8-10mm",30,15,0],
		["Mat: Liston d12mm  ",30,20,0],
		["Mat: Liston 5x10	 ",30,10,0],
		["Mat: Varilla metal ",30,30,0],
		["Mat: Tuerca metal	 ",30,10,0],
		["Mat: Panel madera  ",30,50,0],
		["Mat: Panel corcho	 ",30,50,0],
		["Mat: Carton ondulad",30,20,0],
		["Mat: Cuerda 1m	 ",30,10,0],
		["Mat: Hembrilla	  ",30,5,0],
		["Mat: Polea     	 ",30,30,0],
		["Mat: Clavos 2ud 	  ",30,5,0],
		["Mat: Gomas largas	  ",30,2,0],
		["Mat: Gomas cortas	  ",30,1,0],
		["Mat: Bridas    	  ",30,5,0],
		["Mat: Cola blanca	 ",30,15,0],
		["Mat: Cinta american",30,15,0],

		
	];
	
	var Materiales=[
	//{material,coste_coger},
		["Mat: Liston madera ",10],
		["Mat: Liston d4-6mm ",10],
		["Mat: Liston d8-10mm",15],
		["Mat: Liston d12mm  ",20],
		["Mat: Liston 5x10	 ",10],
		["Mat: Varilla metal ",30],
		["Mat: Tuerca metal	 ",10],
		["Mat: Panel madera  ",50],
		["Mat: Panel corcho	 ",50],
		["Mat: Carton ondulad",20],
		["Mat: Cuerda 1m	 ",10],
		["Mat: Hembrilla	  ",5],
		["Mat: Polea     	 ",30],
		["Mat: Clavos 2ud 	  ",5],
		["Mat: Gomas largas	  ",2],
		["Mat: Gomas cortas	  ",1],
		["Mat: Bridas    	  ",5],
		["Mat: Cola blanca	 ",15],
		["Mat: Cinta american",15],
		["Mat: Varios",1],
	];
	
	var Alq=new Array();
	// Alq [equipo] [slot] [0: herramienta ; 1: tiempo]
	var Points=new Array();
	// Points [equipo] [0:puntos ; 1:numero de alquileres]
	var History=new Array();
	// Histoty [equipo] [0:comma separated list (excel) ; 1:human readable (mostrado en la lista)]
	
	Actualizar.count=0;


	//Para guardar como csv
	function UpdateSaveTextLink(textToWrite)
	{
	
		var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
	
		var downloadLink = document.getElementById("b");
		downloadLink.innerHTML = "Download as CSV";
		downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
		
	}	
	function Encode(str)
	{
		return str.replace(/,/igm,"_").replace(/\|/igm,"_");
	}
	
	//Parte activa:
	function Actualizar()
	{
		document.body.style.background="RGB(255,255,255)";
		document.all.imgback.style.opacity=100;
		Actualizar.count+=1;
		var t=(new Date()).getTime()/1000;
		for(i=0;i<Teams.length;i++) //Para cada equipo [i]
		{
			for(j=0;j<nSlots;j++) //Para cada slot [j]
			{

				if(Alq[i][j][0]==-1) //Si no está alquilado se deja "Libre" y el fondo en blanco.

				{
					document.a["t_"+i+"_"+j].value="Libre";
					document.a["t_"+i+"_"+j].style.background="RGB(255,255,255)"; 
				}
				else
				{
				    // actualizar tiempo
					delta=-t+(Alq[i][j][1]+60*Herr[Alq[i][j][0]][1]);
					if(delta<0)
						document.a["t_"+i+"_"+j].value="    - "+parseInt(-delta/60)+":"+(parseInt(-delta%60)<10?"0":"")+parseInt(-delta%60);
					else
						document.a["t_"+i+"_"+j].value=parseInt(delta/60)+":"+(parseInt(delta%60)<10?"0":"")+parseInt(delta%60);
					document.a["m_"+i+"_"+j].value=Alq[i][j][0];
					//colores
					if(delta/60<0)
					{
						document.a["t_"+i+"_"+j].style.background="RGB(255,"+(Actualizar.count%3>1?255:0)+","+(Actualizar.count%3<1?255:0)+")";
						if(Actualizar.count%10<5)
						{
							//document.body.style.background="RGB(255,100,100)"; Parpadea toda la pantalla (con colorines) => Epilepsia onfaya
							//document.all.imgback.style.opacity=0;
							
							document.a["t_"+i+"_"+j].style.background="RGB(255,100,100)"; //Parpadea solo el recuadro del tiempo que se ha pasado. 
																						// => Epilepsia resuelta. El fondo se mantiene normal.
						}
					}
					else if(delta/60<1)
						document.a["t_"+i+"_"+j].style.background="RGB(255,"+(Actualizar.count%6<3?255:0)+","+(Actualizar.count%6<3?255:0)+")";
					else if(delta/60<5)
						document.a["t_"+i+"_"+j].style.background="RGB(255,255,"+(Actualizar.count%8<4?255:0)+")";					
					else if(delta/60<10)
						document.a["t_"+i+"_"+j].style.background="RGB(255,255,100)";		
					else 
						document.a["t_"+i+"_"+j].style.background="RGB(255,255,255)";
				}
			}
			document.a["p_"+i].value=parseInt(Points[i][0]);
			document.a["n_"+i].value=Points[i][1];
			document.a["history_"+i].value=History[i][1];
			History[i][2]=Encode(document.a["comment_"+i].value);
		}
		// guardar estado
		localStorage.setItem('Points',Points);
		localStorage.setItem('Alq',Alq);	
		localStorage.setItem('History',History);
		var out ="";
		for(i=0;i<Teams.length;i++) //Para cada equipo [i]
		{
			out += Encode(Teams[i])+"\ncuando,posicion,elemento,accion,tiempo,puntos,total puntos,transacciones,equipo\n"+(History[i][0]).replace(/\|/igm,",")+"\nCOMMENTS:\n"+History[i][2]+"\n\n\n";
		}
		UpdateSaveTextLink(out);
	}
	
	function AddToHistory(team,slot,time,name,action,delta_t,delta_points,cummulated_points_after,num_alq)
	{
		time=parseInt(time)
		History[team][0]+=time+"|"+slot+"|"+Encode(name)+"|"+action+"|"+delta_t+"|"+delta_points+"|"+cummulated_points_after+"|"+num_alq+"|"+Encode(Teams[team])+"\n"
		if(action=="Comprar")
			History[team][1]="** "+time+": "+action+" "+delta_t+" "+name+" en la posición "+slot+" por "+delta_points+" puntos. El equipo "+Teams[team]+" tiene ahora "+
				cummulated_points_after+" puntos en total. Total "+num_alq+" transacciones.\n"+History[team][1]
		else
			History[team][1]="** "+time+": "+action+" "+name+" en la posición "+slot+" por "+delta_points+" puntos. El equipo "+Teams[team]+" tiene ahora "+
				cummulated_points_after+" puntos en total. Total "+num_alq+" transacciones.\n"+History[team][1]
			
	}
	
	function Alquilar(team,slot)
	{
		if(Alq[team][slot][0]==-1)
		{
			var t=(new Date()).getTime()/1000;
			var h=Number(document.a["m_"+team+"_"+slot].value);
			if((h>-1) && (h<Herr.length))
			{
				Alq[team][slot][0]=h;
				Alq[team][slot][1]=t;
				AddToHistory(team,slot,t,Herr[h][0]+"("+Herr[h][2]+")","Alquilar",0,0,Points[team][0],Points[team][1]);
			}
			else
				alert("seleccione la herramienta a alquilar");
		}
		else
		{
			alert("Devuelva "+Herr[Alq[team][slot][0]][0]+" antes de alquilar de nuevo");
		}	
	}
	
	function Devolver(team,slot)
	{
		if(Alq[team][slot][0]!=-1)
		{
			var t=(new Date()).getTime()/1000;
			Points[team][0]+=(t-Alq[team][slot][1])/60*Herr[Alq[team][slot][0]][3]+Herr[Alq[team][slot][0]][2];
			Points[team][1]+=1;
			var h = Alq[team][slot][0];
			AddToHistory(team,slot,t,Herr[h][0]+"("+Herr[h][2]+")","Devolver",t-Alq[team][slot][1],
			            (t-Alq[team][slot][1])/60*Herr[Alq[team][slot][0]][3]+Herr[Alq[team][slot][0]][2],
						      Points[team][0],Points[team][1]);
			Alq[team][slot][0]=-1;
			Alq[team][slot][1]=0;
		}
		else
		{alert("Nada alquilado");}
	}

	function Corregir(team,slot)
	{
		if(Alq[team][slot][0]!=-1)
		{
			if(confirm("CORREGIR?\nDevolver "+Herr[Alq[team][slot][0]][0]+" \ndel equipo "+Teams[team]+" en la posición "+slot+" \nsin modificar los puntos?"))
			{
				var h = Alq[team][slot][0];
				AddToHistory(team,slot,(new Date()).getTime()/1000,Herr[h][0]+"("+Herr[h][2]+")","Corregir",0,0,Points[team][0],Points[team][1]);
				Alq[team][slot][0]=-1;
				Alq[team][slot][1]=0;
			}
		}
		else
		{alert("Nada alquilado");}
	}
	
	//////////////////////////////////////
	function Comprar(team,slot)
	{
		var idCuad = "t_" + team + "_" + slot;
		var idDesplegable = "m_" + team + "_" + slot
		var CantidadComprar = document.getElementById(idCuad).value;
		var matCompr = document.getElementById(idDesplegable).value;
		
		if (matCompr == -1)
		{
		
			alert("Nada para comprar");
			
		}else if(CantidadComprar==0)
		{
			
			alert("Seleccionar cantidad");
			
		}else{
		
			Points[team][0]+=Materiales[matCompr][1]*CantidadComprar;
			Points[team][1]+=1*CantidadComprar;
			AddToHistory(team,slot,(new Date()).getTime()/1000,Materiales[matCompr][0]+"("+Materiales[matCompr][1]+")","Comprar",CantidadComprar,Materiales[matCompr][1]*CantidadComprar,Points[team][0],Points[team][1]);
			
		}
	}
	
	/////////////////////////////////////
	
	
	//generador HTML
	for(i=0;i<Teams.length;i++)
	{
		Alq[i]=new Array();
		Points[i]=[0,0];
		History[i]=["","",""];
		
		document.write("<tr><td><div align=\"center\"><font size=\"5\">Equipo "+Teams[i]+"</font></div></td><td><div align=\"center\"><p><b>Alquiler de herramientas</b></p>");
		for(j=0;j<nSlots;j++)
		{
			Alq[i][j]=[-1,0];
			document.write("<select id=\"m_"+i+"_"+j+"\"><option value=\"-1\">-</option>");
			for(k=0;k<Herr.length;k++)
			{
				document.write("<option value=\""+k+"\">"+Herr[k][0]+"("+Herr[k][2]+")"+"</option>");
			}
			document.write("</select><br>");
		}
		//Código del cuadro de herramientas
		
		document.write("<p><b>Compra de materiales</b></p><select id=\"m_"+i+"_"+j+"\"><option value=\"-1\">-</option>");
		for(k=0;k<Materiales.length;k++)
		{
			document.write("<option value=\""+k+"\">"+Materiales[k][0]+"("+Materiales[k][1]+")"+"</option>");
		}
		document.write("</select><br><br>");
		
		
		document.write("</div></td><td><div align=\"center\"><br><br><br>");
		
		
		
		for(j=0;j<nSlots;j++)
		{
			document.write("<input id=\"t_"+i+"_"+j+"\" type=\"text\" readonly value=\"0\" style=\"width:100px;\"><br>");			
		}
		document.write("<p><b>Cantidad</b></p><input id=\"t_"+i+"_"+j+"\" type=\"text\" value=\"0\" style=\"width:100px;text-align:center;\"><br>");
		document.write("<br><br></div></td><td><br>");
		for(j=0;j<nSlots;j++)
		{
			document.write("<div align=\"center\">");
			document.write("<input type=\"button\" value=\"Alquilar\" onclick=\"Alquilar("+i+","+j+")\" >");		
			document.write("<input type=\"button\" value=\"Devolver\" onclick=\"Devolver("+i+","+j+")\" >");			
			document.write("<input type=\"button\" value=\"Corregir\" onclick=\"Corregir("+i+","+j+")\" ></div>");			
		}
		//Botón de comprar
		document.write("<br><br><div align=\"center\"><input type=\"button\" value=\"Comprar\" onclick=\"Comprar("+i+","+j+")\" ></div>");
		
		document.write("</td><td><input id=\"p_"+i+"\" type=\"text\" readonly value=\"0\" style=\"width:50px;\"></td>");			
		document.write("<td><input id=\"n_"+i+"\" type=\"text\" readonly value=\"0\" style=\"width:50px;\"></td><td><textarea id=comment_"+i
		               +" rows=\"10\" style=\"width:500px;\"></textarea></td><td><textarea id=history_"+i+" rows=\"10\" style=\"width:1500px;\"></textarea></td>");
	}
	
	//CARGA de datos
	if (localStorage.getItem('Points'))
		if(confirm("Cargar datos guardados?")||confirm("Va a SOBREESCRIBIR LOS DATOS ANTERIORES!\nCargar datos guardados?"))
		{
			foo=localStorage.getItem('Points').split(",");
			for(i=0;i<foo.length;i+=2)
			{
				Points[i/2][0]=Number(foo[i]);
				Points[i/2][1]=Number(foo[i+1]);				
			}
			foo=localStorage.getItem('Alq').split(",");			
			for(i=0;i<foo.length;i+=nSlots*2)
			{
				for(j=0;j<nSlots;j++)
				{
					Alq[i/(nSlots*2)][j][0]=Number(foo[i+2*j]);
					Alq[i/(nSlots*2)][j][1]=Number(foo[i+2*j+1]);
				}					
			}
			foo=localStorage.getItem('History').split(",");
			for(i=0;i<foo.length;i+=3)
			{
				History[i/3][0]=foo[i];
				History[i/3][1]=foo[i+1];
				History[i/3][2]=foo[i+2];
				document.a["comment_"+i/3].value=History[i/3][2];
			}
		}
	
	//Arranque
	self.setInterval(function(){Actualizar()},200);
//-->
</script>
  </tbody>	
  </table>
 </form>
 <p/>
 <a id="b" download="EBEC_results.csv"></a>
</body>
</html>

